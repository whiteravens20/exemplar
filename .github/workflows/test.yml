name: Tests

on:
  push:
    branches: [ main, dev ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - uses: actions/checkout@v6

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Update npm to 11+
        run: npm install -g npm@latest

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint --if-present

      - name: Run all tests
        run: npm run test:all

      - name: Security audit
        run: |
          npm audit --production --audit-level=high || true
          echo "⚠️ Security audit completed (warnings only)"
        continue-on-error: true

      - name: Check for syntax errors
        run: |
          node -c src/index.js
          node -c src/deploy-commands.js
          for file in src/events/*.js; do node -c "$file"; done
          for file in src/slashcommands/*.js; do node -c "$file"; done
          for file in src/utils/*.js; do node -c "$file"; done

      - name: Verify required files
        run: |
          test -f src/index.js || (echo "src/index.js missing" && exit 1)
          test -f src/deploy-commands.js || (echo "src/deploy-commands.js missing" && exit 1)
          test -f package.json || (echo "package.json missing" && exit 1)
          test -f Dockerfile || (echo "Dockerfile missing" && exit 1)
          echo "✅ All required files present"

      - name: Verify environment variables
        run: |
          test -f .env.example || (echo ".env.example missing" && exit 1)
          grep -q "DISCORD_TOKEN" .env.example || (echo "DISCORD_TOKEN not in .env.example" && exit 1)
          grep -q "N8N_WORKFLOW_URL" .env.example || (echo "N8N_WORKFLOW_URL not in .env.example" && exit 1)
          echo "✅ Environment variables configured"

      - name: Node.js version check
        run: |
          REQUIRED_VERSION="22"
          CURRENT_VERSION=$(node -v | cut -d'v' -f2 | cut -d'.' -f1)
          if [ "$CURRENT_VERSION" -lt "$REQUIRED_VERSION" ]; then
            echo "❌ Node.js $REQUIRED_VERSION+ required, got v$(node -v)"
            exit 1
          fi
          echo "✅ Node.js version OK: v$(node -v)"

      - name: Package.json validation
        run: |
          npm ls --depth=0 2>&1 | grep -q "ERR!" && (echo "❌ Package.json has issues" && exit 1) || echo "✅ Package.json OK"
